<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Agent Swarm — Contain the Rogue Agents</title>
<meta property="og:title" content="Agent Swarm — Can You Contain the Rogue Agents?">
<meta property="og:description" content="A retro arcade game celebrating Claude Code Agent Teams. Deploy. Contain. Survive.">
<meta property="og:type" content="website">
<meta name="theme-color" content="#0D0D12">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{background:#0D0D12;width:100%;height:100%;overflow:hidden;
    font-family:'Press Start 2P',monospace;touch-action:none;
    -webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
  #W{position:relative;width:100%;height:100%}
  canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges}
  #S{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;
    background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 6px);z-index:10}
</style>
</head>
<body>
<div id="W"><canvas id="C"></canvas><div id="S"></div></div>
<script>
const canvas=document.getElementById('C'),ctx=canvas.getContext('2d');
const GW=640,GH=780;
let scale=1;

function resize(){
  const ww=window.innerWidth,wh=window.innerHeight;
  scale=Math.min(ww/GW,wh/GH);
  canvas.width=GW;canvas.height=GH;
  canvas.style.width=(GW*scale)+'px';
  canvas.style.height=(GH*scale)+'px';
  canvas.style.position='absolute';
  canvas.style.left=((ww-GW*scale)/2)+'px';
  canvas.style.top=((wh-GH*scale)/2)+'px';
}
window.addEventListener('resize',resize);resize();

// ─── AUDIO ───────────────────────────────────────────────────────────
const AC=window.AudioContext||window.webkitAudioContext;
let actx=null,sndOn=true;
function ensureAudio(){
  if(!actx){try{actx=new AC()}catch(e){sndOn=false}}
  if(actx?.state==='suspended')actx.resume();
}
function sfx(type){
  if(!sndOn||!actx)return;
  try{
    const t=actx.currentTime;
    if(type==='shoot'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='square';o.frequency.setValueAtTime(880,t);o.frequency.exponentialRampToValueAtTime(220,t+0.07);
      g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.07);
      o.start(t);o.stop(t+0.07);
    } else if(type==='hit'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(80,t+0.12);
      g.gain.setValueAtTime(0.09,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
      o.start(t);o.stop(t+0.12);
    } else if(type==='kill'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='square';o.frequency.setValueAtTime(400,t);
      o.frequency.exponentialRampToValueAtTime(800,t+0.04);
      o.frequency.exponentialRampToValueAtTime(100,t+0.18);
      g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.18);
      o.start(t);o.stop(t+0.18);
    } else if(type==='killboss'){
      // deeper, more satisfying boss explosion
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(600,t);
      o.frequency.exponentialRampToValueAtTime(40,t+0.4);
      g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      o.start(t);o.stop(t+0.4);
      // layered click
      const o2=actx.createOscillator(),g2=actx.createGain();
      o2.connect(g2);g2.connect(actx.destination);
      o2.type='square';o2.frequency.setValueAtTime(120,t);o2.frequency.exponentialRampToValueAtTime(30,t+0.3);
      g2.gain.setValueAtTime(0.08,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o2.start(t+0.05);o2.stop(t+0.35);
    } else if(type==='powerup'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sine';
      o.frequency.setValueAtTime(300,t);
      o.frequency.exponentialRampToValueAtTime(900,t+0.12);
      // fixed: use linearRamp instead of setValueAtTime to avoid scheduling conflict
      o.frequency.linearRampToValueAtTime(600,t+0.16);
      o.frequency.exponentialRampToValueAtTime(1200,t+0.3);
      g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.start(t);o.stop(t+0.3);
    } else if(type==='shield'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sine';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(440,t+0.2);
      g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.start(t);o.stop(t+0.3);
    } else if(type==='nuke'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(20,t+0.6);
      g.gain.setValueAtTime(0.15,t);g.gain.linearRampToValueAtTime(0,t+0.6);
      o.start(t);o.stop(t+0.6);
    } else if(type==='damage'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(40,t+0.3);
      g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      o.start(t);o.stop(t+0.3);
    } else if(type==='gameover'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sawtooth';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(30,t+0.8);
      g.gain.setValueAtTime(0.1,t);g.gain.linearRampToValueAtTime(0,t+0.8);
      o.start(t);o.stop(t+0.8);
    } else if(type==='wave'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sine';o.frequency.setValueAtTime(440,t);
      o.frequency.exponentialRampToValueAtTime(660,t+0.08);
      o.frequency.exponentialRampToValueAtTime(880,t+0.2);
      g.gain.setValueAtTime(0.07,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
      o.start(t);o.stop(t+0.35);
    } else if(type==='combo'){
      const o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type='sine';
      o.frequency.setValueAtTime(660,t);o.frequency.exponentialRampToValueAtTime(990,t+0.06);
      g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);
      o.start(t);o.stop(t+0.1);
    }
  }catch(e){}
}

// ─── PALETTE ─────────────────────────────────────────────────────────
const C={
  bg:'#0D0D12',tan:'#E8D5B7',orange:'#CF774B',coral:'#E0926B',
  rust:'#A0522D',cream:'#F5E6D3',dark:'#1A1410',accent:'#FF6B35',
  green:'#5CB85C',cyan:'#5BC0BE',purple:'#8B5CF6',red:'#E74C3C',
  dim:'#6B5D50',grid:'rgba(207,119,75,0.04)',gold:'#FFD700',
  shieldBlue:'#4FC3F7',
};

// ─── STATE ───────────────────────────────────────────────────────────
let state='title',score=0,lives=3,wave=1;
let showWaveBanner=false,waveBannerTimer=0;
let hi=0;try{hi=parseInt(localStorage.getItem('agentSwarmHi')||'0')||0}catch(e){}
let newHi=false;
let shake={x:0,y:0,i:0};
let stars=[],titlePulse=0,gt=0;
let combo=0,comboTimer=0,maxCombo=0;
let nukeFlash=0;

const WAVES=['Solo Repo','Feature Branch','Monorepo Madness','CI/CD Pipeline',
  'Enterprise Fleet','Production Meltdown','The Singularity','Infinite Loop','Heat Death','New Game+'];
const TASKS=[
  'rm -rf node_modules','Rewrote in Rust','Deleted prod DB','Gained sentience',
  'npm install chaos','Leaked .env','Infinite recursion','Zombie process',
  'Force pushed main','Feature not a bug','Hallucinated API','while(true)',
  'Deprecated everything','Stack overflow','Segfault','Spaghetti refactor',
  'Deployed on Friday','TODO: fix later','Random sort()','Ghost dependency',
  'sudo rm -rf /','git blame everyone','Eval is evil','Dropped all tables',
  'Left debug logs','Committed secrets','Broke the build',
];

let player=null,bullets=[],enemies=[],eBullets=[];
let particles=[],powerUps=[],popups=[];

// ─── STARS ───────────────────────────────────────────────────────────
function initStars(){
  stars=[];
  for(let i=0;i<80;i++)
    stars.push({x:Math.random()*GW,y:Math.random()*GH,s:Math.random()*1.5+0.5,
      sp:Math.random()*0.3+0.1,b:Math.random()*0.5+0.2});
}
function updateStars(){for(const s of stars){s.y+=s.sp;if(s.y>GH){s.y=0;s.x=Math.random()*GW}}}
function drawStars(){
  for(const s of stars){
    ctx.globalAlpha=s.b+Math.sin(gt*0.02+s.x)*0.15;
    ctx.fillStyle=C.tan;ctx.fillRect(s.x|0,s.y|0,s.s,s.s);
  }
  ctx.globalAlpha=1;
}
function drawGrid(){
  ctx.strokeStyle=C.grid;ctx.lineWidth=1;
  const sp=40,off=(gt*0.2)%sp;
  for(let y=off;y<GH;y+=sp){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(GW,y);ctx.stroke()}
  for(let x=0;x<GW;x+=sp){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,GH);ctx.stroke()}
}

// ─── PLAYER ──────────────────────────────────────────────────────────
function mkPlayer(){
  return{x:GW/2,y:GH-70,w:44,h:32,speed:5,fireRate:12,cd:0,
    pu:null,puTime:0,inv:0,mv:{l:false,r:false},fire:false,thr:0,tx:null,
    shield:false,shieldTime:0};
}

function drawPlayer(p){
  const px=(p.x-p.w/2)|0,py=(p.y-p.h/2)|0;
  if(p.inv>0&&(gt/4|0)%2===0)return;

  // Shield bubble
  if(p.shield){
    const pulse=Math.sin(gt*0.15)*6;
    ctx.strokeStyle=C.shieldBlue;ctx.lineWidth=2;
    ctx.globalAlpha=0.4+Math.sin(gt*0.2)*0.15;
    ctx.beginPath();ctx.arc(p.x,p.y,p.w/2+10+pulse,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=0.08;ctx.fillStyle=C.shieldBlue;ctx.fill();
    ctx.globalAlpha=1;
  }

  // Thruster
  p.thr+=0.15;
  const ts=6+Math.sin(p.thr*3)*3;
  ctx.fillStyle=C.accent;ctx.globalAlpha=0.6+Math.sin(p.thr*5)*0.3;
  ctx.fillRect(px+p.w/2-4,py+p.h,8,ts);
  ctx.fillStyle=C.cream;ctx.globalAlpha=0.8;
  ctx.fillRect(px+p.w/2-2,py+p.h,4,ts-2);
  ctx.globalAlpha=1;

  // Ship body
  ctx.fillStyle=C.tan;ctx.fillRect(px+8,py+8,28,20);
  ctx.fillStyle=C.orange;ctx.fillRect(px+16,py,12,12);
  ctx.fillStyle=C.coral;ctx.fillRect(px+19,py-4,6,6);
  ctx.fillStyle=C.rust;ctx.fillRect(px,py+16,10,12);ctx.fillRect(px+34,py+16,10,12);
  ctx.fillStyle=C.orange;ctx.fillRect(px-2,py+20,4,6);ctx.fillRect(px+42,py+20,4,6);
  // Terminal screen
  ctx.fillStyle='#1a2a1a';ctx.fillRect(px+14,py+12,16,10);
  ctx.fillStyle=C.green;
  ctx.fillRect(px+15,py+13,14,2);ctx.fillRect(px+15,py+16,10,2);ctx.fillRect(px+15,py+19,12,2);

  // Power-up aura
  if(p.pu){
    const col={headless:C.cyan,multi:C.purple,yolo:C.red,pierce:C.gold}[p.pu]||C.accent;
    ctx.fillStyle=col;ctx.globalAlpha=0.2+Math.sin(gt*0.2)*0.12;
    ctx.fillRect(px-6,py-6,p.w+12,p.h+12);ctx.globalAlpha=1;
  }
}

function updatePlayer(p){
  if(p.tx!==null){
    const dx=p.tx-p.x;
    if(Math.abs(dx)>2)p.x+=Math.sign(dx)*Math.min(Math.abs(dx)*0.18,p.speed*1.2);
  }else{
    if(p.mv.l)p.x-=p.speed;
    if(p.mv.r)p.x+=p.speed;
  }
  p.x=Math.max(p.w/2+10,Math.min(GW-p.w/2-10,p.x));
  if(p.inv>0)p.inv--;
  if(p.shield){p.shieldTime--;if(p.shieldTime<=0)p.shield=false}
  if(p.pu){p.puTime--;if(p.puTime<=0)p.pu=null}
  const rate=p.pu==='headless'?4:p.fireRate;
  if(p.cd>0)p.cd--;
  if(p.fire&&p.cd<=0){fireBullet(p);p.cd=rate}
}

// Throttle shoot sfx during rapid fire
let lastShootSfx=0;
function fireBullet(p){
  if(gt-lastShootSfx>=4){sfx('shoot');lastShootSfx=gt}
  const bx=p.x,by=p.y-p.h/2;
  const pc=p.pu==='pierce';
  if(p.pu==='multi'){
    bullets.push({x:bx,y:by,vy:-8,vx:0,w:4,h:10});
    bullets.push({x:bx-14,y:by+4,vy:-7.5,vx:-1.8,w:4,h:10});
    bullets.push({x:bx+14,y:by+4,vy:-7.5,vx:1.8,w:4,h:10});
  }else if(p.pu==='yolo'){
    bullets.push({x:bx,y:by,vy:-6,vx:0,w:14,h:20,big:true});
  }else if(pc){
    bullets.push({x:bx,y:by,vy:-8,vx:0,w:4,h:10,pierce:true});
  }else{
    bullets.push({x:bx,y:by,vy:-8,vx:0,w:4,h:10});
  }
}

// ─── ENEMIES ─────────────────────────────────────────────────────────
let eDir=1,eSpd=0.5,eDrop=18,eFire=0.002,eAnim=0;

function spawnWave(wn){
  enemies=[];
  const rows=Math.min(3+Math.floor(wn/2),6);
  const cols=Math.min(6+Math.floor(wn/3),10);
  const sx=(GW-(cols-1)*52)/2;
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const t=r<1?2:r<3?1:0;
    enemies.push({x:sx+c*52,y:65+r*46,w:32,h:28,type:t,hp:t+1,alive:true,af:0,fl:0});
  }
  eDir=1;
  // Smoother difficulty curve with caps
  eSpd=Math.min(0.35+wn*0.1,1.8);
  eDrop=Math.min(16+wn*0.5,24);
  eFire=Math.min(0.0008+wn*0.0005,0.005);
}

function drawEnemy(e){
  if(!e.alive)return;
  const px=(e.x-e.w/2)|0,py=(e.y-e.h/2)|0,f=e.af;
  if(e.fl>0){ctx.fillStyle='#FFF';ctx.globalAlpha=0.8;ctx.fillRect(px-2,py-2,e.w+4,e.h+4);ctx.globalAlpha=1;e.fl--}

  if(e.type===0){
    ctx.fillStyle=C.coral;ctx.fillRect(px+4,py+4,24,18);
    ctx.fillStyle=C.orange;ctx.fillRect(px+8,py,16,6);
    ctx.fillStyle='#FFF';ctx.fillRect(px+8,py+8,6,6);ctx.fillRect(px+18,py+8,6,6);
    ctx.fillStyle=C.dark;ctx.fillRect(px+(f?10:9),py+10,3,3);ctx.fillRect(px+(f?20:19),py+10,3,3);
    ctx.fillStyle=C.coral;ctx.fillRect(px+(f?6:4),py+22,6,4);ctx.fillRect(px+(f?20:22),py+22,6,4);
  }else if(e.type===1){
    ctx.fillStyle=C.orange;ctx.fillRect(px+2,py+6,28,16);
    ctx.fillStyle=C.accent;ctx.fillRect(px+6,py+2,20,8);
    ctx.fillStyle=C.cream;ctx.fillRect(px+14,py-4,4,6);ctx.fillRect(px+12,py-6,8,3);
    ctx.fillStyle=C.dark;ctx.fillRect(px+7,py+10,8,4);ctx.fillRect(px+17,py+10,8,4);
    ctx.fillStyle=C.cream;ctx.fillRect(px+(f?9:8),py+11,4,2);ctx.fillRect(px+(f?19:18),py+11,4,2);
    ctx.fillStyle=C.orange;ctx.fillRect(px-2,py+(f?10:8),4,8);ctx.fillRect(px+30,py+(f?10:8),4,8);
  }else{
    ctx.fillStyle=C.rust;ctx.fillRect(px,py+4,32,20);
    ctx.fillStyle=C.red;ctx.fillRect(px+4,py,24,8);
    ctx.fillStyle=C.accent;ctx.globalAlpha=0.6+Math.sin(gt*0.15)*0.3;
    ctx.fillRect(px+10,py+8,12,8);ctx.globalAlpha=1;
    ctx.fillStyle='#FFF';ctx.fillRect(px+13,py+10,6,4);
    ctx.fillStyle=C.red;ctx.fillRect(px+2,py-4,4,6);ctx.fillRect(px+26,py-4,4,6);
    ctx.fillStyle=C.rust;ctx.fillRect(px+(f?2:0),py+24,8,4);ctx.fillRect(px+(f?22:24),py+24,8,4);
  }
}

function updateEnemies(){
  if(!player||state!=='playing')return;
  eAnim++;
  if(eAnim>=30){eAnim=0;for(const e of enemies)if(e.alive)e.af=1-e.af}
  let edge=false;
  for(const e of enemies){if(!e.alive)continue;e.x+=eSpd*eDir;if(e.x+e.w/2>GW-20||e.x-e.w/2<20)edge=true}
  if(edge){eDir*=-1;for(const e of enemies)if(e.alive)e.y+=eDrop}
  for(const e of enemies){
    if(!e.alive)continue;
    if(Math.random()<eFire)eBullets.push({x:e.x,y:e.y+e.h/2,vy:Math.min(3.5+wave*0.2,6.5),w:5,h:10});
    if(e.y+e.h/2>player.y-30)triggerGameOver();
  }
}

// ─── POWER-UPS (5 types) ────────────────────────────────────────────
const PU_TYPES=[
  {type:'headless',label:'RAPID',color:C.cyan,desc:'RAPID FIRE!'},
  {type:'multi',label:'MULTI',color:C.purple,desc:'SPREAD SHOT!'},
  {type:'yolo',label:'YOLO',color:C.red,desc:'BIG BLAST!'},
  {type:'pierce',label:'PIERCE',color:C.gold,desc:'PIERCE THROUGH!'},
  {type:'shield',label:'SHIELD',color:C.shieldBlue,desc:'SHIELD UP!'},
  {type:'nuke',label:'NUKE',color:'#FF4444',desc:'NUKE!'},
];

function spawnPU(x,y){
  // Weighted: shield/nuke are rarer
  const roll=Math.random();
  let pu;
  if(roll<0.25)pu=PU_TYPES[0];      // headless 25%
  else if(roll<0.45)pu=PU_TYPES[1];  // multi 20%
  else if(roll<0.60)pu=PU_TYPES[2];  // yolo 15%
  else if(roll<0.75)pu=PU_TYPES[3];  // pierce 15%
  else if(roll<0.90)pu=PU_TYPES[4];  // shield 15%
  else pu=PU_TYPES[5];               // nuke 10%
  powerUps.push({x,y,vy:1.2,w:36,h:20,...pu,pulse:0});
}

function drawPU(pu){
  pu.pulse+=0.1;
  const g=Math.sin(pu.pulse)*5;
  // Outer glow
  ctx.fillStyle=pu.color;ctx.globalAlpha=0.15+Math.sin(pu.pulse)*0.1;
  ctx.fillRect(pu.x-pu.w/2-g,pu.y-pu.h/2-g,pu.w+g*2,pu.h+g*2);
  ctx.globalAlpha=1;
  // Box
  ctx.fillStyle=C.dark;ctx.fillRect(pu.x-pu.w/2,pu.y-pu.h/2,pu.w,pu.h);
  ctx.strokeStyle=pu.color;ctx.lineWidth=2;
  ctx.strokeRect(pu.x-pu.w/2,pu.y-pu.h/2,pu.w,pu.h);
  // Label
  ctx.fillStyle=pu.color;ctx.font='7px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText(pu.label,pu.x,pu.y+3);
}

// ─── PARTICLES ───────────────────────────────────────────────────────
function boom(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=(Math.PI*2/n)*i+Math.random()*0.5,sp=1+Math.random()*3;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:30+Math.random()*20,ml:50,sz:2+Math.random()*3,color});
  }
}

// Ring explosion for nuke/shield
function boomRing(x,y,color,radius){
  for(let i=0;i<32;i++){
    const a=(Math.PI*2/32)*i;
    particles.push({x:x+Math.cos(a)*radius*0.3,y:y+Math.sin(a)*radius*0.3,
      vx:Math.cos(a)*4,vy:Math.sin(a)*4,life:40,ml:40,sz:3,color});
  }
}

function popup(x,y,text,color,big){
  popups.push({x,y,text,life:big?100:80,vy:-0.7,color:color||C.cream,big:!!big});
}

function updateParticles(){
  particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.96;p.vy*=0.96;return--p.life>0});
  popups=popups.filter(t=>{t.y+=t.vy;return--t.life>0});
}
function drawParticles(){
  for(const p of particles){ctx.globalAlpha=p.life/p.ml;ctx.fillStyle=p.color;ctx.fillRect(p.x|0,p.y|0,p.sz,p.sz)}
  ctx.globalAlpha=1;
  for(const t of popups){
    ctx.globalAlpha=Math.min(1,t.life/25);
    ctx.font=(t.big?'11':'8')+'px "Press Start 2P"';
    ctx.textAlign='center';
    // Text shadow for readability
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.fillText(t.text,t.x+1,t.y+1);
    ctx.fillStyle=t.color;
    ctx.fillText(t.text,t.x,t.y);
  }
  ctx.globalAlpha=1;
}

// ─── BULLETS ─────────────────────────────────────────────────────────
function drawBullets(){
  for(const b of bullets){
    if(b.big){
      ctx.fillStyle=C.red;ctx.globalAlpha=0.3;ctx.fillRect(b.x-b.w,b.y-2,b.w*2,b.h+4);
      ctx.globalAlpha=1;ctx.fillStyle=C.accent;ctx.fillRect(b.x-b.w/2,b.y,b.w,b.h);
      ctx.fillStyle='#FFF';ctx.fillRect(b.x-3,b.y+2,6,b.h-4);
    }else if(b.pierce){
      ctx.fillStyle=C.gold;ctx.fillRect(b.x-b.w/2,b.y,b.w,b.h);
      ctx.fillStyle='#FFF';ctx.fillRect(b.x-1,b.y+1,2,b.h-2);
    }else{
      ctx.fillStyle=C.accent;ctx.fillRect(b.x-b.w/2,b.y,b.w,b.h);
      ctx.fillStyle=C.cream;ctx.fillRect(b.x-1,b.y+1,2,b.h-2);
    }
  }
  // Enemy bullets — distinct red diamonds
  for(const b of eBullets){
    ctx.save();ctx.translate(b.x,b.y+b.h/2);ctx.rotate(Math.PI/4);
    ctx.fillStyle='#FF3333';ctx.fillRect(-3,-3,6,6);
    ctx.fillStyle='#FF8888';ctx.fillRect(-1.5,-1.5,3,3);
    ctx.restore();
  }
}
function updateBullets(){
  bullets=bullets.filter(b=>{b.x+=(b.vx||0);b.y+=b.vy;return b.y>-20&&b.x>-20&&b.x<GW+20});
  eBullets=eBullets.filter(b=>{b.y+=b.vy;return b.y<GH+20});
}

// ─── COLLISION ───────────────────────────────────────────────────────
function hitbox(ax,ay,aw,ah,bx,by,bw,bh){
  return ax-aw/2<bx+bw/2&&ax+aw/2>bx-bw/2&&ay-ah/2<by+bh/2&&ay+ah/2>by-bh/2;
}

function doNuke(){
  sfx('nuke');
  nukeFlash=15;
  addShake(12);
  let nukeScore=0;
  for(const e of enemies){
    if(!e.alive)continue;
    e.alive=false;
    nukeScore+=(e.type+1)*50; // Half points for nuke kills
    boom(e.x,e.y,[C.orange,C.coral,C.accent][e.type],8);
  }
  score+=nukeScore;
  boomRing(player.x,player.y,C.red,200);
  popup(GW/2,GH/2-40,'NUKE! +'+nukeScore,C.red,true);
}

function checkCollisions(){
  if(!player)return;

  // Bullets -> Enemies
  for(let bi=bullets.length-1;bi>=0;bi--){
    const b=bullets[bi];if(!b)continue;
    for(const e of enemies){
      if(!e.alive)continue;
      if(hitbox(b.x,b.y+b.h/2,b.big?b.w*2:b.w,b.h,e.x,e.y,e.w,e.h)){
        e.hp--;e.fl=4;
        if(!b.big&&!b.pierce)bullets.splice(bi,1);
        if(e.hp<=0){
          e.alive=false;
          // Combo system
          combo++;comboTimer=90; // 1.5 seconds to keep combo
          if(combo>maxCombo)maxCombo=combo;
          const mult=combo>=10?4:combo>=5?3:combo>=3?2:1;
          const basePts=(e.type+1)*100;
          const pts=basePts*mult;
          score+=pts;

          if(e.type===2)sfx('killboss');else sfx('kill');
          boom(e.x,e.y,[C.orange,C.coral,C.accent][e.type],e.type===2?24:16);
          popup(e.x,e.y-20,'+'+pts,mult>1?C.gold:C.accent);
          if(mult>1){
            sfx('combo');
            popup(e.x,e.y-40,mult+'x COMBO',C.gold,true);
          }
          if(Math.random()<0.35)popup(e.x,e.y-55,TASKS[Math.random()*TASKS.length|0],C.dim);
          if(Math.random()<0.12)spawnPU(e.x,e.y); // 12% drop rate
          addShake(e.type===2?6:4);
        }else{sfx('hit');addShake(2)}
        break;
      }
    }
  }

  // Enemy bullets -> Player
  if(player.inv<=0){
    for(let i=eBullets.length-1;i>=0;i--){
      const b=eBullets[i];
      if(hitbox(b.x,b.y+b.h/2,b.w,b.h,player.x,player.y,player.w-8,player.h-4)){
        eBullets.splice(i,1);
        if(player.shield){
          // Shield absorbs hit
          player.shield=false;player.shieldTime=0;
          sfx('shield');boom(player.x,player.y,C.shieldBlue,12);
          popup(player.x,player.y-30,'SHIELD BLOCKED!',C.shieldBlue);
          addShake(4);
        }else{
          hitPlayer();
        }
        break;
      }
    }
  }

  // Power-ups -> Player
  for(let i=powerUps.length-1;i>=0;i--){
    const pu=powerUps[i];
    if(hitbox(pu.x,pu.y,pu.w,pu.h,player.x,player.y,player.w+12,player.h+12)){
      if(pu.type==='shield'){
        player.shield=true;player.shieldTime=600; // 10 seconds
        sfx('shield');
      }else if(pu.type==='nuke'){
        doNuke();
      }else{
        player.pu=pu.type;player.puTime=420; // 7 seconds
      }
      if(pu.type!=='nuke')sfx('powerup');
      boom(pu.x,pu.y,pu.color,10);
      popup(pu.x,pu.y-24,pu.desc,pu.color,true);
      addShake(3);powerUps.splice(i,1);
    }
  }

  // Wave clear
  if(enemies.every(e=>!e.alive)){
    wave++;showWaveBanner=true;waveBannerTimer=120;
    sfx('wave');spawnWave(wave);
  }
}

function hitPlayer(){
  lives--;player.inv=90;sfx('damage');
  boom(player.x,player.y,C.cream,20);addShake(10);
  combo=0;comboTimer=0; // Reset combo on hit
  if(lives<=0)triggerGameOver();
}

function triggerGameOver(){
  if(state==='gameover')return;
  state='gameover';sfx('gameover');
  newHi=score>hi&&score>0;
  if(newHi){hi=score;try{localStorage.setItem('agentSwarmHi',hi.toString())}catch(e){}}
}

function addShake(v){shake.i=Math.max(shake.i,v)}
function updateShake(){
  if(shake.i>0){shake.x=(Math.random()-0.5)*shake.i*2;shake.y=(Math.random()-0.5)*shake.i*2;shake.i*=0.82;if(shake.i<0.5)shake.i=0}
  else{shake.x=0;shake.y=0}
}

// ─── HUD ─────────────────────────────────────────────────────────────
function drawHUD(){
  // Semi-transparent HUD background strip
  ctx.fillStyle='rgba(13,13,18,0.65)';ctx.fillRect(0,0,GW,54);

  // Score
  ctx.font='11px "Press Start 2P"';ctx.textAlign='left';ctx.fillStyle=C.tan;
  ctx.fillText('SCORE',16,20);
  ctx.fillStyle=C.accent;ctx.font='16px "Press Start 2P"';
  ctx.fillText(score.toString().padStart(6,'0'),16,44);

  // Wave
  ctx.font='11px "Press Start 2P"';ctx.textAlign='center';ctx.fillStyle=C.dim;
  ctx.fillText('WAVE '+wave,GW/2,20);
  ctx.font='8px "Press Start 2P"';ctx.fillStyle=C.orange;
  ctx.fillText(WAVES[Math.min(wave-1,WAVES.length-1)],GW/2,40);

  // Lives
  ctx.textAlign='right';ctx.font='11px "Press Start 2P"';ctx.fillStyle=C.tan;
  ctx.fillText('LIVES',GW-16,20);
  for(let i=0;i<lives;i++){
    const lx=GW-28-i*24;
    ctx.fillStyle=C.orange;ctx.fillRect(lx,28,18,13);
    ctx.fillStyle=C.coral;ctx.fillRect(lx+5,24,8,6);
  }

  // Combo indicator
  if(combo>=3){
    ctx.textAlign='center';
    ctx.font='10px "Press Start 2P"';
    const mult=combo>=10?4:combo>=5?3:2;
    ctx.fillStyle=C.gold;
    ctx.globalAlpha=0.8+Math.sin(gt*0.3)*0.2;
    ctx.fillText(mult+'x COMBO ('+combo+')',GW/2,68);
    ctx.globalAlpha=1;
  }

  // Power-up timer bar
  if(player?.pu){
    const bw=140,bh=8,bx=GW/2-bw/2,by=GH-28;
    const pct=player.puTime/420;
    const col={headless:C.cyan,multi:C.purple,yolo:C.red,pierce:C.gold}[player.pu]||C.accent;
    ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(bx-2,by-2,bw+4,bh+4);
    ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(bx,by,bw,bh);
    ctx.fillStyle=col;ctx.fillRect(bx,by,bw*pct,bh);
    ctx.font='8px "Press Start 2P"';ctx.textAlign='center';ctx.fillStyle=C.cream;
    ctx.fillText(player.pu.toUpperCase(),GW/2,by-6);
  }

  // Shield indicator
  if(player?.shield){
    const by=player?.pu?GH-50:GH-28;
    ctx.font='8px "Press Start 2P"';ctx.textAlign='center';
    ctx.fillStyle=C.shieldBlue;
    ctx.globalAlpha=0.7+Math.sin(gt*0.15)*0.3;
    ctx.fillText('SHIELD ACTIVE',GW/2,by);
    ctx.globalAlpha=1;
  }

  // Wave banner
  if(showWaveBanner){
    waveBannerTimer--;
    if(waveBannerTimer<=0)showWaveBanner=false;
    const a=waveBannerTimer>90?(120-waveBannerTimer)/30:waveBannerTimer/90;
    ctx.globalAlpha=a;
    ctx.font='28px "Press Start 2P"';ctx.textAlign='center';
    ctx.fillStyle=C.accent;ctx.fillText('WAVE '+wave,GW/2,GH/2-20);
    ctx.font='12px "Press Start 2P"';ctx.fillStyle=C.tan;
    ctx.fillText(WAVES[Math.min(wave-1,WAVES.length-1)],GW/2,GH/2+14);
    ctx.globalAlpha=1;
  }
}

// ─── TITLE SCREEN ────────────────────────────────────────────────────
const isMobile='ontouchstart'in window||navigator.maxTouchPoints>0;

function drawTitle(){
  titlePulse+=0.03;
  ctx.fillStyle=C.bg;ctx.fillRect(0,0,GW,GH);
  drawGrid();drawStars();

  // Floating ghost agents
  for(let i=0;i<8;i++){
    const ax=GW/2+Math.cos(titlePulse+i*0.8)*(120+i*30);
    const ay=180+Math.sin(titlePulse*0.7+i*1.1)*60+i*22;
    ctx.globalAlpha=0.15+Math.sin(titlePulse+i)*0.08;
    ctx.fillStyle=[C.coral,C.orange,C.rust][i%3];
    ctx.fillRect(ax-12,ay-10,24,18);
    ctx.fillStyle='#FFF';ctx.fillRect(ax-6,ay-4,4,4);ctx.fillRect(ax+2,ay-4,4,4);
    ctx.globalAlpha=1;
  }

  const ty=260;

  // Title glow
  ctx.fillStyle=C.accent;ctx.globalAlpha=0.15+Math.sin(titlePulse*2)*0.1;
  ctx.font='40px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText('AGENT',GW/2,ty);ctx.fillText('SWARM',GW/2,ty+54);ctx.globalAlpha=1;
  // Title solid
  ctx.fillStyle=C.cream;ctx.font='38px "Press Start 2P"';
  ctx.fillText('AGENT',GW/2,ty);
  ctx.fillStyle=C.accent;ctx.fillText('SWARM',GW/2,ty+54);

  // Tagline
  ctx.font='8px "Press Start 2P"';ctx.fillStyle=C.dim;
  ctx.fillText('ROGUE AGENTS HAVE ESCAPED THE SANDBOX',GW/2,ty+92);

  // Divider
  ctx.strokeStyle=C.orange;ctx.globalAlpha=0.4;ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(GW/2-160,ty+110);ctx.lineTo(GW/2+160,ty+110);ctx.stroke();ctx.globalAlpha=1;

  // Branding
  ctx.font='10px "Press Start 2P"';ctx.fillStyle=C.orange;
  ctx.fillText('CLAUDE CODE AGENT TEAMS',GW/2,ty+138);

  // Controls
  ctx.font='9px "Press Start 2P"';ctx.fillStyle=C.tan;
  if(isMobile){
    ctx.fillText('DRAG TO MOVE',GW/2,ty+186);
    ctx.fillText('HOLD TO FIRE',GW/2,ty+204);
  }else{
    ctx.fillText('\u2190 \u2192 MOVE   SPACE FIRE',GW/2,ty+186);
    ctx.fillText('P PAUSE',GW/2,ty+204);
  }

  // Start prompt
  ctx.globalAlpha=0.4+Math.sin(titlePulse*3)*0.4;
  ctx.font='14px "Press Start 2P"';ctx.fillStyle=C.accent;
  ctx.fillText(isMobile?'TAP TO DEPLOY':'PRESS ENTER TO DEPLOY',GW/2,ty+262);
  ctx.globalAlpha=1;

  // High score
  if(hi>0){ctx.font='9px "Press Start 2P"';ctx.fillStyle=C.dim;ctx.fillText('HIGH SCORE: '+hi.toString().padStart(6,'0'),GW/2,GH-60)}

  // Footer
  ctx.font='7px "Press Start 2P"';ctx.fillStyle=C.dim;ctx.globalAlpha=0.5;
  ctx.fillText('BUILT WITH CLAUDE CODE',GW/2,GH-30);ctx.globalAlpha=1;
}

// ─── GAME OVER ───────────────────────────────────────────────────────
function drawGameOver(){
  ctx.fillStyle='rgba(13,13,18,0.85)';ctx.fillRect(0,0,GW,GH);
  const cy=GH/2-80;

  // Panel
  ctx.fillStyle='rgba(26,20,16,0.95)';ctx.fillRect(GW/2-220,cy-40,440,320);
  ctx.strokeStyle=C.rust;ctx.lineWidth=2;ctx.strokeRect(GW/2-220,cy-40,440,320);

  ctx.font='30px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillStyle=C.red;ctx.fillText('SYSTEM',GW/2,cy+14);
  ctx.fillStyle=C.accent;ctx.fillText('CRASHED',GW/2,cy+52);

  ctx.font='11px "Press Start 2P"';ctx.fillStyle=C.tan;ctx.fillText('AGENTS CONTAINED',GW/2,cy+95);
  ctx.fillStyle=C.accent;ctx.font='22px "Press Start 2P"';ctx.fillText(score.toString().padStart(6,'0'),GW/2,cy+126);

  ctx.font='9px "Press Start 2P"';ctx.fillStyle=C.dim;
  ctx.fillText('WAVE: '+wave+'   MAX COMBO: '+maxCombo,GW/2,cy+155);

  if(newHi){
    ctx.fillStyle=C.gold;ctx.font='11px "Press Start 2P"';
    ctx.fillText('\u2605 NEW HIGH SCORE \u2605',GW/2,cy+185);
  }else{
    ctx.fillStyle=C.dim;ctx.font='9px "Press Start 2P"';
    ctx.fillText('HIGH SCORE: '+hi.toString().padStart(6,'0'),GW/2,cy+185);
  }

  // Restart prompt
  ctx.globalAlpha=0.4+Math.sin(gt*0.1)*0.4;
  ctx.font='11px "Press Start 2P"';ctx.fillStyle=C.cream;
  ctx.fillText(isMobile?'TAP TO REDEPLOY':'PRESS ENTER TO REDEPLOY',GW/2,cy+235);
  ctx.globalAlpha=1;

  // Branding
  ctx.font='7px "Press Start 2P"';ctx.fillStyle=C.dim;ctx.globalAlpha=0.4;
  ctx.fillText('BUILT WITH CLAUDE CODE',GW/2,cy+270);ctx.globalAlpha=1;
}

function drawPause(){
  ctx.fillStyle='rgba(13,13,18,0.7)';ctx.fillRect(0,0,GW,GH);
  ctx.font='30px "Press Start 2P"';ctx.textAlign='center';ctx.fillStyle=C.cream;
  ctx.fillText('PAUSED',GW/2,GH/2-10);
  ctx.font='11px "Press Start 2P"';ctx.fillStyle=C.dim;
  ctx.fillText('PRESS P TO RESUME',GW/2,GH/2+30);
}

// ─── GAME LOOP ───────────────────────────────────────────────────────
function startGame(){
  ensureAudio();state='playing';score=0;lives=3;wave=1;
  combo=0;comboTimer=0;maxCombo=0;newHi=false;
  bullets=[];eBullets=[];particles=[];powerUps=[];popups=[];
  player=mkPlayer();spawnWave(1);
  showWaveBanner=true;waveBannerTimer=120;sfx('wave');
}

function update(){
  gt++;updateStars();updateShake();
  if(nukeFlash>0)nukeFlash--;

  if(state==='playing'){
    // Combo decay
    if(comboTimer>0){comboTimer--;if(comboTimer<=0)combo=0}

    updatePlayer(player);updateBullets();updateEnemies();
    checkCollisions();updateParticles();
    powerUps=powerUps.filter(pu=>{pu.y+=pu.vy;return pu.y<GH+20});
  }
}

function draw(){
  ctx.save();ctx.translate(shake.x,shake.y);
  ctx.fillStyle=C.bg;ctx.fillRect(-10,-10,GW+20,GH+20);

  if(state==='title'){drawTitle()}
  else{
    drawGrid();drawStars();
    if(state==='playing'||state==='gameover'||state==='paused'){
      enemies.forEach(drawEnemy);
      if(player)drawPlayer(player);
      drawBullets();powerUps.forEach(drawPU);drawParticles();drawHUD();
    }
    if(state==='gameover')drawGameOver();
    if(state==='paused')drawPause();

    // Nuke flash overlay
    if(nukeFlash>0){
      ctx.fillStyle='#FFF';ctx.globalAlpha=nukeFlash/15*0.4;
      ctx.fillRect(0,0,GW,GH);ctx.globalAlpha=1;
    }
  }
  ctx.restore();
}

function loop(){update();draw();requestAnimationFrame(loop)}

// ─── KEYBOARD ────────────────────────────────────────────────────────
document.addEventListener('keydown',e=>{
  if(e.code==='Enter'||e.code==='Space'){
    if(state==='title'){startGame();e.preventDefault();return}
    if(state==='gameover'){startGame();e.preventDefault();return}
  }
  if(e.code==='KeyP'&&(state==='playing'||state==='paused')){
    state=state==='paused'?'playing':'paused';e.preventDefault();return;
  }
  if(state==='playing'&&player){
    if(e.code==='ArrowLeft'||e.code==='KeyA')player.mv.l=true;
    if(e.code==='ArrowRight'||e.code==='KeyD')player.mv.r=true;
    if(e.code==='Space'){player.fire=true;e.preventDefault()}
  }
});
document.addEventListener('keyup',e=>{
  if(!player)return;
  if(e.code==='ArrowLeft'||e.code==='KeyA')player.mv.l=false;
  if(e.code==='ArrowRight'||e.code==='KeyD')player.mv.r=false;
  if(e.code==='Space')player.fire=false;
});

// ─── TOUCH ───────────────────────────────────────────────────────────
let touchActive=false;
function touchGameX(touch){const r=canvas.getBoundingClientRect();return(touch.clientX-r.left)/scale}

canvas.addEventListener('touchstart',e=>{
  e.preventDefault();ensureAudio();
  if(state==='title'){startGame();return}
  if(state==='gameover'){startGame();return}
  if(state==='playing'&&player){
    touchActive=true;
    player.fire=true;
    player.tx=touchGameX(e.touches[0]);
  }
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(state==='playing'&&player&&touchActive)player.tx=touchGameX(e.touches[0]);
},{passive:false});

canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.touches.length===0){
    touchActive=false;
    if(player){
      player.tx=null;
      player.fire=false; // BUG FIX: stop firing when finger lifts
    }
  }
},{passive:false});

// Mouse click fallback
canvas.addEventListener('click',()=>{
  ensureAudio();
  if(state==='title')startGame();
  else if(state==='gameover')startGame();
});

// ─── INIT ────────────────────────────────────────────────────────────
initStars();loop();
</script>
</body>
</html>
